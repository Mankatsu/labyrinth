  :root {
    --cell-max: 32px;
    --cell-min: 18px;
    --page-x-padding: 14px;
    --size: clamp(var(--cell-min),
                  calc((100vw - (2 * var(--page-x-padding)) - 40px) / 15),
                  var(--cell-max));
    --wall-color: #d60000;
    --fork-color: #ffd400;
    --ladder-color: #ff8ad8;
    --exit-color: #4ade80;
    --opened-color: #b3e5ff;
    --select-outline: #1d7cff;
    --dpad-base: 64;
    --dpad-size: clamp(48px, calc(38px + 3vw), calc(var(--dpad-base) * 1px));
    --dpad-gap: var(--dpad-size);
  }

  * {
    -webkit-tap-highlight-color: rgba(0,0,0,0);
    box-sizing: border-box;
  }

  body {
    font-family: system-ui, Arial, sans-serif;
    margin: 0;
    background: #f5f5f7;
    color: #222;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    font-size: clamp(14px, 0.95rem + 0.3vw, 17px);
  }

  header {
    padding: 12px 16px;
    background: #222;
    color: #fff;
  }

  h1 {
    font-size: clamp(18px, 1rem + 0.6vw, 28px);
    margin: 0 0 4px 0;
  }

  #app {
    display: flex;
    gap: clamp(12px, 2vw, 20px);
    padding: 12px 14px 28px;
    flex-wrap: wrap;
    align-items: flex-start;
    width: 100%;
  }

  .panel {
    background: #ffffff;
    border: 1px solid #ddd;
    border-radius: 14px;
    padding: 14px 14px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,.06);
    position: relative;
    flex: 1 1 320px;
    min-width: 260px;
    max-width: 100%;
  }

  .panel h2 {
    font-size: clamp(13px, 0.75rem + 0.4vw, 16px);
    margin: 0;
    font-weight: 600;
    letter-spacing: .5px;
    text-transform: uppercase;
    color: #555;
  }

  #gridWrapper {
    position: relative;
    max-width: 100%;
    overflow: auto;
    overscroll-behavior: contain;
    touch-action: pan-x pan-y;
    border-radius: 10px;
    border: 1px solid #ddd;
    background: #fff;
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(15, var(--size));
    grid-template-rows: repeat(15, var(--size));
    gap: 0;
    user-select: none;
    touch-action: none;
  }

  .cell {
    position: relative;
    width: var(--size);
    height: var(--size);
    font-size: clamp(9px, calc(var(--size)*0.33), 13px);
    line-height: 1;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 2px 3px;
    background: #fff;
    border: 1px dashed #d0d0d0;
    cursor: pointer;
    transition: background .12s, transform .08s;
    touch-action: none;
  }
  .cell:active { background: #e2f0ff; transform: scale(.97); }
  .cell:hover { background: #eef6ff; }
  .cell.selected { outline: 2px solid var(--select-outline); outline-offset: -2px; z-index: 5; }

  .cell.fork:not(.ladder):not(.exit)   { background: var(--fork-color); }
  .cell.ladder:not(.fork):not(.exit)   { background: var(--ladder-color); }
  .cell.exit:not(.fork):not(.ladder)   { background: var(--exit-color); }
  .cell.fork.ladder:not(.exit)  { background: linear-gradient(135deg, var(--fork-color) 0 50%, var(--ladder-color) 50% 100%); }
  .cell.fork.exit:not(.ladder)  { background: linear-gradient(135deg, var(--fork-color) 0 50%, var(--exit-color) 50% 100%); }
  .cell.ladder.exit:not(.fork)  { background: linear-gradient(135deg, var(--ladder-color) 0 50%, var(--exit-color) 50% 100%); }
  .cell.fork.ladder.exit {
    background: linear-gradient(135deg,
      var(--fork-color) 0 33.34%,
      var(--ladder-color) 33.34% 66.67%,
      var(--exit-color) 66.67% 100%);
  }
  .cell.wall-top { border-top: 4px solid var(--wall-color); }
  .cell.wall-right { border-right: 4px solid var(--wall-color); }
  .cell.wall-bottom { border-bottom: 4px solid var(--wall-color); }
  .cell.wall-left { border-left: 4px solid var(--wall-color); }
  .cell.opened { background: var(--opened-color) !important; }

  .controls-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
    align-items: stretch;
  }
  .controls-group > button {
    flex: 1 1 120px;
  }

  button {
    border: 1px solid #b7b7b7;
    background: #fff;
    padding: 8px clamp(10px, 1.2vw, 14px);
    font-size: clamp(13px, 0.8rem + 0.3vw, 15px);
    border-radius: 10px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: background .15s, border-color .15s, transform .06s;
    min-height: 38px;
    touch-action: manipulation;
    max-width: 100%;
  }
  button:focus-visible { outline: 2px solid #1d7cff; outline-offset: 2px; }
  button:hover { background: #f0f6ff; }
  button:active { transform: translateY(1px); }
  button.primary { background: #1d7cff; border-color: #1d7cff; color: #fff; }
  button.primary:hover { background:#0f66d9; }

  .icon-btn { padding: 8px 10px; font-size: 16px; line-height: 1; min-width: 44px; justify-content: center; }
  .icon-btn.small { padding: 6px 8px; min-height: 38px; font-size: 18px; }
  .icon-btn .hint { font-size: 10px; font-weight: 600; letter-spacing: .5px; margin-left: 2px; opacity: .6; }

  .floor-buttons button.active { background:#222; color:#fff; border-color:#222; }
  .section { margin-bottom: 18px; }
  .small-note { font-size: 11px; color:#666; margin-top:4px; line-height:1.35; }

  .export-area {
    width: 100%;
    min-height: 110px;
    font-family: ui-monospace, monospace;
    font-size: 12px;
    padding: 8px;
    border-radius: 8px;
    border:1px solid #ccc;
    resize: vertical;
  }
  .export-area.short { min-height:80px; }

  .badge {
    display:inline-block;
    font-size:10px;
    background:#444;
    padding:2px 6px;
    border-radius: 20px;
    margin-left:6px;
    letter-spacing:.5px;
    text-transform:uppercase;
    color:#fff;
  }

  footer {
    margin-top: auto;
    padding: 12px 20px 20px;
    font-size: 12px;
    text-align: center;
    color: #666;
  }

  .legend {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    font-size: 12px;
    margin-top: 6px;
    margin-bottom: 4px;
  }
  .legend span { display: inline-flex; align-items:center; gap:4px; }
  .legend i {
    width:16px;height:16px;
    border:1px solid #bbb;
    border-radius:4px;
  }
  .legend i.fork { background: var(--fork-color); }
  .legend i.ladder { background: var(--ladder-color); }
  .legend i.exit { background: var(--exit-color); }
  .legend i.opened { background: var(--opened-color); }
  .legend i.wall { background: linear-gradient(var(--wall-color), var(--wall-color)); border:none; }

  .coords-display { font-size: clamp(11px, 0.65rem + 0.35vw, 14px); font-weight: 600; margin-top: 4px; color:#333; }

  .grid-tools-inline {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .danger { background:#ffe8e8; border-color:#ff5a5a; }
  .danger:hover { background:#ffd0d0; }

  .dpad-row {
    display:flex;
    align-items:flex-start;
    gap: clamp(10px, 2vw, 24px);
    flex-wrap: wrap;
    overflow-x: visible;
    padding-bottom:4px;
    max-width:100%;
  }

  /* --- HORIZONTAL DPAD --- */
  .dpad, .walls-dpad {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: clamp(6px, 1vw, 10px);
    width: 100%;
    justify-content: flex-start;
    flex-wrap: nowrap;
  }

  .dpad button,
  .walls-dpad button {
    width: var(--dpad-size);
    height: var(--dpad-size);
    justify-content: center;
    font-size: clamp(16px, 1rem + 0.5vw, 20px);
    padding: 0;
  }

  /* Порядок для основного D-pad */
  .dpad-left   { order: 1; }
  .dpad-up     { order: 2; }
  .dpad-center { order: 3; font-size: clamp(12px, 0.7rem + 0.4vw, 14px) !important; font-weight:600; letter-spacing:.5px; }
  .dpad-down   { order: 4; }
  .dpad-right  { order: 5; }

  .dpad-center.active { background:#1d7cff; color:#fff; border-color:#1d7cff; }

  /* Порядок для стен */
  .walls-dpad .wall-left  { order: 1; }
  .walls-dpad .wall-up    { order: 2; }
  .walls-dpad .wall-down  { order: 3; }
  .walls-dpad .wall-right { order: 4; }

  .walls-dpad button {
    font-size: clamp(13px, 0.7rem + 0.4vw, 16px);
    font-weight:600;
    line-height:1.15;
    padding:4px 6px;
  }
  .walls-dpad button span {
    display:block;
    font-size: clamp(10px, 0.6rem + 0.25vw, 11px);
    font-weight:500;
    opacity:.7;
    letter-spacing:.4px;
  }

  .walls-dpad button.active-wall { background:#ffe1e1; border-color:#ff7b7b; }

  #gridWrapper::-webkit-scrollbar { width: 10px; height: 10px; }
  #gridWrapper::-webkit-scrollbar-track { background: #f1f1f1; }
  #gridWrapper::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 20px; }
  #gridWrapper::-webkit-scrollbar-thumb:hover { background:#a8a8a8; }

  .zoom-row {
    display:flex;
    align-items:center;
    gap:10px;
    margin: 8px 0 14px;
    flex-wrap: wrap;
  }
  .zoom-row input[type=range] { flex:1; }
  .zoom-badge { min-width: 42px; text-align: right; font-size: 12px; font-weight:600; }

  #statusLine {
    font-size:11px;
    color:#4a4a4a;
    margin-top:6px;
    font-family: ui-monospace, monospace;
    white-space:pre-wrap;
    overflow-wrap:anywhere;
  }

  @media (max-width: 1100px) {
    #app { flex-direction: column; }
    #gridPanel { order: 1; }
    #controlPanelContainer { order: 2; }
  }

  /* Узкий режим сетки */
  @media (max-width: 540px) {
    #grid {
      grid-template-columns: repeat(15, 1fr);
      width: 100%;
      max-width: 100%;
      grid-auto-rows: 1fr;
    }
    .cell {
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
      font-size: clamp(8px, 2.3vw, 12px);
      padding: 2px;
    }
    #app { padding: 10px 10px 22px; }
    .panel { padding: 12px 12px 0; }
    /* D-pad разрешаем перенос, если не уместится */
    .dpad, .walls-dpad {
      flex-wrap: wrap;
      justify-content: center;
    }
    .dpad button,
    .walls-dpad button {
      width: clamp(44px, 16vw, var(--dpad-size));
      height: clamp(44px, 16vw, var(--dpad-size));
    }
    button {
      min-height: 34px;
      padding: 7px 10px;
    }
  }

  @media (max-width: 600px) {
    .legend { font-size:11px; }
    .coords-display { font-size:12px; }
  }